registrationModule.controller("pagoController",function(e,a,n,o,t,r,l,d,s,c,u){e.idEmpresa=2,e.idCuenta=4,e.idUsuario=4,e.currentEmployee=1;var g=function(e,a,n,o){s.error("Ocurrio un problema")};e.init=function(){m(),$.fn.bootstrapSwitch.defaults.offColor="info",$.fn.bootstrapSwitch.defaults.onText="Todos",$.fn.bootstrapSwitch.defaults.offText="Pagables",$(".switch-checkbox").bootstrapSwitch(),e.showSelCartera=!0,e.ingresos=[{id:1,nombre:"Santander",cuenta:94039,saldo:4e4,disponible:4e4,ingreso:1,egreso:0},{id:2,nombre:"Bancomer",cuenta:594833,saldo:79e3,disponible:79e3,ingreso:0,egreso:1},{id:3,nombre:"Banamex",cuenta:100298,saldo:685e3,disponible:685e3,ingreso:0,egreso:1}],e.egresos=[{id:1,nombre:"HSBC",cuenta:228139,saldo:9e4,aTransferir:0,total:9e4,excedente:0,ingreso:0,egreso:1,totalPagar:2e5,saldoIngreso:0},{id:2,nombre:"Bancomer",cuenta:594833,saldo:12e4,aTransferir:0,total:12e4,excedente:0,ingreso:1,egreso:1,totalPagar:45e4,saldoIngreso:0}],e.transferencias=[{bancoOrigen:"",bancoDestino:"",importe:0,disponibleOrigen:0,index:0}]};var p=function(){e.llenaGrid(),e.llenaEncabezado()},m=function(){if(""!=getParameterByName("employee")&&(l.currentEmployee=getParameterByName("employee")),null==l.currentEmployee){var e=1;l.currentEmployee=e}null!=l.currentEmployee?f():(w(),setTimeout(function(){p()},500))},f=function(){""!=getParameterByName("id")&&(l.currentId=getParameterByName("id")),null!=l.currentId?y():(w(),setTimeout(function(){p()},500))},y=function(){""!=getParameterByName("idOp")&&(l.currentIdOp=getParameterByName("idOp")),null!=l.currentIdOp?(w(),setTimeout(function(){p()},500)):(w(),setTimeout(function(){p()},500))};e.llenaEncabezado=function(){c.getEncabezado(e.idCuenta).then(function a(n){e.scencabezado=n.data},function n(e){s.error("Error al obtener los datos del encabezado.")})},e.traeEmpresas=function(){c.getEmpresas(e.idUsuario).then(function a(n){e.empresas=n.data,$("#inicioModal").modal("show"),e.showTotales=!1},function n(e){s.error("Error en empresas.")})},e.traeTotalxEmpresa=function(a,n){c.getTotalxEmpresa(a).then(function o(t){e.GranTotal=0,e.TotalxEmpresas=t.data,e.idEmpresa=a,i=0,e.TotalxEmpresas.forEach(function(a,n){e.GranTotal=e.GranTotal+e.TotalxEmpresas[i].sumaSaldo,i++}),e.traeTotalxEmpresa.emp_nombre=n,e.showTotales=!0,e.showSelCartera=!0},function t(a){e.TotalxEmpresas=[],e.GranTotal=0,e.showGrid=!1,e.showSelCartera=!1,e.showTotales=!1,e.traeTotalxEmpresa.emp_nombre="La empresa seleccionada no tiene información"})},e.MuestraGridModal=function(a){e.showGrid=!0,e.init(),c.getDatos(e.idEmpresa).success(b).error(g),e.gridOptions.columnDefs=[{name:"proveedor",grouping:{groupPriority:0},sort:{priority:0,direction:"asc"},name:"proveedor",width:"50%",cellTemplate:'<div><div ng-if="!col.grouping || col.grouping.groupPriority === undefined || col.grouping.groupPriority === null || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div></div>'},{field:"Pagar",displayName:"Pagar (total)",width:"25%",cellFilter:"currency",aggregationType:t.aggregationTypes.sum,treeAggregationType:o.aggregation.SUM,editableCellTemplate:'<div><form name="inputForm"><input type="number" ng-class="\'colt\' + col.uid" ui-grid-editor ng-model="MODEL_COL_FIELD"></form></div>',customTreeAggregationFinalizerFn:function(e){e.rendered=e.value}},{name:"fechaPromesaPago",displayName:"Fecha Promesa de Pago",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"15%"}]},e.OcultaGridModal=function(a){e.showGrid=a},e.llenaGrid=function(){null!=l.currentId?(c.getDatosAprob(l.currentId).success(b).error(g),e.llenaEncabezado()):c.getDatos(e.idEmpresa).success(b).error(g)};var b=function(a,n,o,t){e.gridOptions.data=a,e.data=a,e.carteraVencida=0,e.cantidadTotal=0,e.cantidadUpdate=0,e.noPagable=0,e.Reprogramable=0;for(var r=0;r<e.data.length;r++)e.data[r].Pagar=e.data[r].saldo,"True"==e.data[r].ordenBloqueada&&(e.data[r].Pagar=0),"False"==e.data[r].documentoPagable&&(e.data[r].Pagar=0),e.carteraVencida=e.carteraVencida+e.data[r].saldo;e.noPagable=e.carteraVencida-e.cantidadTotal,e.gridOptions.data=e.data,setTimeout(function(){e.selectAll()},500)},h=function(e,a){return e.forEach(function(e){e.grouping&&e.grouping.groupPriority>-1&&e.treeAggregation.type!==o.aggregation.CUSTOM&&(e.treeAggregation.type=o.aggregation.CUSTOM,e.customTreeAggregationFn=function(e,a,n,o){"undefined"==typeof e.value&&(e.value=0),e.value=e.value+o.entity.Pagar},e.customTreeAggregationFinalizerFn=function(e){"undefined"!=typeof e.groupVal?e.rendered=e.groupVal+" ("+r("currency")(e.value)+")":e.rendered=null})}),e},w=function(){e.gridOptions={enableGridMenu:!0,enableFiltering:!0,enableGroupHeaderSelection:!0,treeRowHeaderAlwaysVisible:!0,showColumnFooter:!0,showGridFooter:!0,height:900,cellEditableCondition:function(e){return e.row.entity.ordenBloqueada},columnDefs:[{name:"proveedor",grouping:{groupPriority:0},sort:{priority:0,direction:"asc"},width:"20%",name:"proveedor",width:"20%",cellTemplate:'<div><div ng-if="!col.grouping || col.grouping.groupPriority === undefined || col.grouping.groupPriority === null || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div></div>'},{field:"Pagar",displayName:"Pagar (total)",width:"10%",cellFilter:"currency",aggregationType:t.aggregationTypes.sum,treeAggregationType:o.aggregation.SUM,enableCellEdit:1==l.currentIdOp?!1:!0,editableCellTemplate:'<div><form name="inputForm"><input type="number" ng-class="\'colt\' + col.uid" ui-grid-editor ng-model="MODEL_COL_FIELD"></form></div>',customTreeAggregationFinalizerFn:function(e){e.rendered=e.value}},{field:"saldoPorcentaje",displayName:"Porcentaje %",width:"10%",cellFilter:"number: 6",aggregationType:t.aggregationTypes.sum,treeAggregationType:o.aggregation.SUM,enableCellEdit:!1,customTreeAggregationFinalizerFn:function(e){e.rendered=e.value}},{name:"monto",displayName:"Monto",width:"13%",cellFilter:"currency",enableCellEdit:!1},{name:"saldo",displayName:"Saldo",width:"13%",cellFilter:"currency",enableCellEdit:!1},{name:"documento",displayName:"# Documento",width:"15%",enableCellEdit:!1,headerTooltip:"Documento # de factura del provedor",cellClass:"cellToolTip"},{name:"tipo",width:"15%",displayName:"Tipo",enableCellEdit:!1},{name:"tipodocto",width:"15%",displayName:"Tipo Documento",enableCellEdit:!1},{name:"cartera",width:"15%",displayName:"Cartera",enableCellEdit:!1},{name:"moneda",width:"10%",displayName:"Moneda",enableCellEdit:!1},{name:"fechaVencimiento",displayName:"Fecha de Vencimiento",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%",enableCellEdit:!1},{name:"fechaPromesaPago",displayName:"Fecha Promesa de Pago",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%"},{name:"fechaRecepcion",displayName:"Fecha Recepción",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%",enableCellEdit:!1},{name:"fechaFactura",displayName:"Fecha Factura",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%",enableCellEdit:!1},{name:"ordenCompra",displayName:"Orden de compra",width:"13%",enableCellEdit:!1},{name:"estatus",displayName:"Estatus",width:"10%",enableCellEdit:!1},{name:"anticipo",displayName:"Anticipo",width:"10%",enableCellEdit:!1},{name:"anticipoAplicado",displayName:"Anticipo Aplicado",width:"15%",enableCellEdit:!1},{name:"cuenta",width:"15%",displayName:"# Cuenta"},{name:"documentoPagable",width:"15%",displayName:"Estatus del Documento"},{name:"ordenBloqueada",displayName:"Bloqueada",width:"20%",cellTemplate:'<button ng-click="row.entity.ordenBloqueada = !row.entity.ordenBloqueada" ng-model="row.entity.ordenBloqueada" style="{{row.entity.ordenBloqueada ? "background-color: lightgreen" : ""}}"></button>'}],rowTemplate:"<div ng-class=\"{'ordenBloqueada':(row.entity.ordenBloqueada=='True' && ((row.entity.idEstatus < 1 || row.entity.idEstatus > 5) && row.entity.idEstatus != 20) && !row.isSelected),'bloqueadaSelec': (row.isSelected && row.entity.ordenBloqueada=='True') || (row.isSelected && ((row.entity.idEstatus >= 1 && row.entity.idEstatus <= 5) || row.entity.idEstatus == 20)),'selectNormal': (row.isSelected && row.entity.ordenBloqueada=='False' && ((row.entity.idEstatus < 1 || row.entity.idEstatus > 5) && row.entity.idEstatus != 20)),'docIncompletos': (!row.isSelected && ((row.entity.idEstatus >= 1 && row.entity.idEstatus <= 5) || row.entity.idEstatus == 20) && row.entity.ordenBloqueada=='False'),'bloqDocIncom': (!row.isSelected && ((row.entity.idEstatus >= 1 && row.entity.idEstatus <= 5) || row.entity.idEstatus == 20) && row.entity.ordenBloqueada=='True')}\"> <div ng-repeat=\"(colRenderIndex, col) in colContainer.renderedColumns track by col.uid\" class=\"ui-grid-cell\" ng-class=\"{ 'ui-grid-row-header-cell': col.isRowHeader == 'True'}\" ui-grid-cell></div></div>",onRegisterApi:function(a){e.gridApi=a,e.cantidadTotal=e.cantidadTotal,e.gridApi.selection.on.rowSelectionChanged(e,function(a){"undefined"!=typeof a.treeLevel&&a.treeLevel>-1?(children=e.gridApi.treeBase.getRowChildren(a),children.forEach(function(n){a.isSelected?e.gridApi.selection.selectRow(n.entity):e.gridApi.selection.unSelectRow(n.entity)})):a.isSelected?(e.Reprogramable=Math.round(100*e.Reprogramable)/100-Math.round(100*a.entity.Pagar)/100,e.cantidadTotal=Math.round(100*e.cantidadTotal)/100+Math.round(100*a.entity.Pagar)/100):(e.Reprogramable=Math.round(100*e.Reprogramable)/100+Math.round(100*a.entity.Pagar)/100,e.cantidadTotal=Math.round(100*e.cantidadTotal)/100-Math.round(100*a.entity.Pagar)/100)}),a.selection.on.rowSelectionChangedBatch(e,function(a){a.forEach(function(a,n){a.isSelected?e.cantidadTotal=Math.round(100*e.cantidadTotal)/100+Math.round(100*a.entity.Pagar)/100:e.cantidadTotal=Math.round(100*e.cantidadTotal)/100-Math.round(100*a.entity.Pagar)/100})}),a.edit.on.afterCellEdit(e,function(a,n,o,t){if(e.cantidadUpdate=o-t,e.cantidadTotal=Math.round(100*e.cantidadTotal)/100+Math.round(100*e.cantidadUpdate)/100,e.Reprogramable=Math.round(100*e.Reprogramable)/100-Math.round(100*e.cantidadUpdate)/100,"fechaPromesaPago"==n.name)if(""==t)if(""==o);else{old_date=Date.now();var r=new Date(o);r<old_date&&(s.warning("La fecha promesa de pago no puede ser menor a "+old_date+" !!!"),a.fechaPromesaPago=old_date)}else{old_date=Date.now();var r=new Date(o);r<old_date&&(s.warning("La fecha promesa de pago no puede ser menor a "+old_date+"  !!!"),a.fechaPromesaPago=old_date)}"Pagar"==n.name&&(""==t||o>t&&(s.warning("El pago no puede ser mayor a "+t+"  !!!"),a.Pagar=t))}),e.gridApi.selection.selectAllRows()}}};e.selectAll=function(){e.gridApi.selection.selectAllRows()},e.FiltrarCartera=function(a){console.log(a),e.gridApi.grid.columns[21].filters[0].term=a,e.gridApi.core.notifyDataChange(t.dataChange.COLUMN),e.gridApi.grid.refresh()};var E=function(e){return!Array.isArray(e)&&e-parseFloat(e)+1>=0};e.colapsado=!1,e.Resize=function(){e.colapsado=!e.colapsado},e.Guardar=function(){var a=0;angular.forEach(e.ingresos,function(e,n){parseInt(e.disponible)<0&&(a+=1)}),a>0?s.warning("Existen disponibles en valores negativos. Verifique las transferencias."):c.getPagosPadre(l.currentEmployee).then(function n(a){var n=[],o=e.gridApi.grid.rows,t=0;o.forEach(function(e,o){var t={};t.pag_id=a.data,t.pad_polTipo=e.entity.polTipo,t.pad_polAnnio=e.entity.annio,t.pad_polMes=e.entity.polMes,t.pad_polConsecutivo=e.entity.polConsecutivo,t.pad_polMovimiento=e.entity.polMovimiento,t.pad_fechaPromesaPago=""==e.entity.fechaPromesaPago?"01/01/1999":e.entity.fechaPromesaPago,t.pad_saldo=e.entity.Pagar,e.isSelected?t.tab_revision=1:t.tab_revision=0,n.push(t)});var r=angular.toJson(e.ingresos),i=angular.toJson(e.transferencias),d=angular.toJson(e.egresos);c.setDatos(n,l.currentEmployee,a.data,r,i,e.caja,e.cobrar,d).then(function u(e){s.success("Se guardaron los datos.")},function g(e){s.error("Error al guardar Datos")})},function o(e){s.error("Error al insertar en tabla padre.")})},e.addTransferencia=function(){var a=e.transferencias.length,n={bancoOrigen:"",bancoDestino:"",importe:0,index:a};e.transferencias.push(n)},e.delTransferencia=function(a){e.transferencias.splice(a.index,1);var n=0;angular.forEach(e.transferencias,function(e,a){e.index=n,n+=1}),e.calculaTotalOperaciones(),T()},e.selBancoIngreso=function(a,n){a.disponible<=0?s.warning("El saldo disponible de esta cuenta es 0 o menor. Elija otra."):n.bancoOrigen!=a.nombre+"-"+a.cuenta&&(angular.forEach(e.ingresos,function(e,a){e.nombre+"-"+e.cuenta==n.bancoOrigen&&(e.disponible=parseInt(e.disponible)+parseInt(n.importe))}),n.bancoOrigen=a.nombre+"-"+a.cuenta,n.disponibleOrigen=a.disponible,n.importe=0),e.calculaTotalOperaciones(),T()},e.selBancoEgreso=function(a,n){n.bancoDestino=a.nombre+"-"+a.cuenta,e.calculaTotalOperaciones(),T()},e.calculaSaldoIngresos=function(a){var n=0;angular.forEach(e.transferencias,function(e,o){e.bancoOrigen==a.nombre+"-"+a.cuenta&&(n=parseInt(n)+parseInt(e.importe))}),a.disponible=parseInt(a.saldo)-parseInt(n),angular.forEach(e.egresos,function(e,n){a.nombre+"-"+a.cuenta==e.nombre+"-"+e.cuenta&&1==e.ingreso&&(e.saldoIngreso=a.disponible)}),angular.forEach(e.transferencias,function(e,n){e.bancoOrigen==a.nombre+"-"+a.cuenta&&(e.disponibleOrigen=a.disponible)}),parseInt(a.disponible)<0&&s.warning("El saldo disponible de esta cuenta es menor a 0. Verifique las transferencias."),e.calculaTotalOperaciones()},e.calculaTransferencia=function(a){var n=0;angular.forEach(e.transferencias,function(e,o){e.bancoOrigen==a.bancoOrigen&&(n+=1)}),1==n?(a.importe>a.disponibleOrigen||a.disponibleOrigen<=0)&&(s.warning("El valor es mayor al saldo disponible!"),a.importe=0):angular.forEach(e.ingresos,function(e,n){e.nombre+"-"+e.cuenta==a.bancoOrigen&&(e.disponible-a.importe<0?(s.warning("El valor es mayor al saldo disponible!"),a.importe=0):e.disponible=e.disponible-a.importe)}),e.calculaTotalOperaciones(),T()};var T=function(){angular.forEach(e.ingresos,function(a,n){a.disponible=a.saldo,angular.forEach(e.transferencias,function(e,n){a.nombre+"-"+a.cuenta==e.bancoOrigen&&(a.disponible=a.disponible-e.importe)})})};e.calculaTotalOperaciones=function(){angular.forEach(e.egresos,function(a,n){var o=0;angular.forEach(e.transferencias,function(e,n){e.bancoDestino==a.nombre+"-"+a.cuenta&&(o+=parseInt(e.importe))}),a.aTransferir=o,a.total=a.aTransferir+(1==a.ingreso)?parseInt(a.saldoIngreso):parseInt(a.saldo),a.excedente=a.totalPagar-a.total})},e.presskey=function(e){13===e.which&&$(this).focusout()},e.getTotal=function(a){var n=0;switch(a){case"egresosTotal":angular.forEach(e.egresos,function(e,a){n+=parseInt(e.total)});break;case"ingresoSaldo":angular.forEach(e.ingresos,function(e,a){n+=parseInt(""==e.saldo?0:e.saldo)});break;case"ingresoDisponible":angular.forEach(e.ingresos,function(e,a){n+=parseInt(""==e.disponible?0:e.disponible)});break;case"b":}return n}}),registrationModule.service("stats",function(){var e=function(e,n){a(e),angular.isUndefined(e.stats.accumulator)&&(e.stats.accumulator=[]),e.stats.accumulator.push(n)},a=function(e){angular.isUndefined(e.stats)&&(e.stats={sum:0})},n=function(e,a){angular.isUndefined(e[a])?e[a]=1:e[a]++},o={aggregator:{accumulate:{numValue:function(a,n,o){return e(a,o)},fieldValue:function(a,n){return e(a,n)}},mode:function(e,o){a(e);var t=o;(angular.isUndefined(t)||null===t)&&(t=e.col.grid.options.groupingNullLabel),n(e.stats,t),(e.stats[t]>e.maxCount||angular.isUndefined(e.maxCount))&&(e.maxCount=e.stats[t],e.value=t)},sumSquareErr:function(e,t,r){a(e),n(e.stats,"count"),e.stats.sum+=r,o.aggregator.accumulate.numValue(e,t,r)}},finalizer:{cleanup:function(e){delete e.stats,angular.isUndefined(e.rendered)&&(e.rendered=e.value)},sumSquareErr:function(e){if(e.value=0,0!==e.count){var a=e.stats.sum/e.stats.count,n;angular.forEach(e.stats.accumulator,function(o){n=o-a,e.value+=n*n})}}}};return o});