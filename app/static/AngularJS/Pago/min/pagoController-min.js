registrationModule.controller("pagoController",function(a,e,o,t,n,r,s,d,l,c,u){a.idEmpresa=4,a.idCuenta=4,a.idUsuario=4,s.currentEmployee=2,s.currentId=null,s.currentIdOp=null,a.idLote=0,s.formData={},a.radioModel="",a.radioTotales=1,a.fechaHoy=new Date;var g=function(a,e,o,t){l.error("Ocurrio un problema")};a.iniciaCheck=function(){$("#switch-onText").bootstrapSwitch(),$("#switch-onText").on("switchChange.bootstrapSwitch",function(){var e=$("#switch-onText").bootstrapSwitch("state");e?a.OcultaGridModal(!1):a.MuestraGridModal(!0)})},a.init=function(){if(a.caja=0,a.cobrar=0,y(),s.accionPagina=!1,$.fn.bootstrapSwitch.defaults.offColor="info",$.fn.bootstrapSwitch.defaults.onText="Lote",$.fn.bootstrapSwitch.defaults.offText="Global",$(".switch-checkbox").bootstrapSwitch(),a.showSelCartera=!0,a.llenaEncabezado(),a.transferencias=[{bancoOrigen:"",bancoDestino:"",importe:0,disponibleOrigen:0,index:0}],s.idOperacion=0,""!=getParameterByName("idOperacion")){s.idOperacion=getParameterByName("idOperacion");var e=getParameterByName("idLote");c.getLotes(a.idEmpresa,s.currentEmployee,0,e).then(function o(e){c.getTotalxEmpresa(a.idEmpresa).then(function o(e){s.GranTotal=0,s.TotalxEmpresas=e.data,a.idEmpresa=a.idEmpresa,i=0,s.TotalxEmpresas.forEach(function(a,e){s.GranTotal=s.GranTotal+s.TotalxEmpresas[i].sumaSaldo,i++}),a.showTotales=!0,a.showSelCartera=!0},function t(e){s.TotalxEmpresas=[],s.GranTotal=0,s.showGrid=!1,a.showSelCartera=!1,a.showTotales=!1,a.traeTotalxEmpresa.emp_nombre="La empresa seleccionada no tiene información"}),s.noLotes=e,s.noLotes.data.length>0&&($("#inicioModal").modal("hide"),l.success("Total de lotes: "+s.noLotes.data.length),s.idLotePadre=s.noLotes.data[s.noLotes.data.length-1].idLotePago,s.estatusLote=s.noLotes.data[s.noLotes.data.length-1].estatus,s.accionPagina=!0,s.ConsultaLote(s.noLotes.data[s.noLotes.data.length-1],s.noLotes.data.length,0),s.ProgPago=!0)},function t(a){l.error("Error al obtener el Lote")})}};var p=function(){if(""!=getParameterByName("employee")&&(s.currentEmployee=getParameterByName("employee")),null==s.currentEmployee){var a=1;s.currentEmployee=a}null!=s.currentEmployee?f():(y(),setTimeout(function(){Prepagos()},500))},f=function(){""!=getParameterByName("id")&&(s.currentId=getParameterByName("id")),null!=s.currentId?m():(y(),setTimeout(function(){Prepagos()},500))},m=function(){""!=getParameterByName("idOp")&&(s.currentIdOp=getParameterByName("idOp")),null!=s.currentIdOp?(y(),setTimeout(function(){Prepagos()},500)):(y(),setTimeout(function(){Prepagos()},500))};a.llenaEncabezado=function(){c.getEncabezado(a.idCuenta).then(function e(o){a.scencabezado=o.data},function o(a){l.error("Error al obtener los datos del encabezado.")})},a.traeEmpresas=function(){s.showGrid=!1,c.getEmpresas(a.idUsuario).then(function e(o){a.empresas=o.data,$("#inicioModal").modal("show"),a.showTotales=!1},function o(a){l.error("Error en empresas.")})},a.traeBancosCompleta=function(){c.getBancosCompleta(a.idEmpresa).then(function e(a){s.bancosCompletas=a.data,s.GranTotalaPagar=0,s.GranTotalnoPagable=0,s.GranTotalPagable=0,i=0,s.bancosCompletas.forEach(function(a,e){s.GranTotalaPagar=s.GranTotalaPagar+s.bancosCompletas[i].sumaSaldo,s.GranTotalnoPagable=s.GranTotalnoPagable+s.bancosCompletas[i].sumaSaldoNoPagable,s.GranTotalPagable=s.GranTotalPagable+s.bancosCompletas[i].sumaSaldoPagable,i++})},function o(a){l.error("Error en bancos con todos sus saldos.")})},a.traeTotalxEmpresa=function(e,o){$("#btnTotalxEmpresa").button("loading"),a.showTotales=!1,a.showSelCartera=!1,c.getTotalxEmpresa(e).then(function t(n){s.GranTotal=0,s.TotalxEmpresas=n.data,a.idEmpresa=e,i=0,s.TotalxEmpresas.forEach(function(a,e){s.GranTotal=s.GranTotal+s.TotalxEmpresas[i].sumaSaldo,i++}),a.traeTotalxEmpresa.emp_nombre=o,a.showTotales=!0,a.showSelCartera=!0,a.ObtieneLotes(0),$("#btnTotalxEmpresa").button("reset")},function n(e){s.TotalxEmpresas=[],s.GranTotal=0,s.showGrid=!1,a.showSelCartera=!1,a.showTotales=!1,a.traeTotalxEmpresa.emp_nombre="La empresa seleccionada no tiene información",$("#btnTotalxEmpresa").button("reset")}),a.traeBancosCompleta()},a.ObtieneLotes=function(e){c.getLotes(a.idEmpresa,s.currentEmployee,0,0).then(function o(a){s.noLotes=a,0!=e&&(s.noLotes.data.push(e),s.estatusLote=0),s.noLotes.data.length>0?(l.success("Total de lotes: "+s.noLotes.data.length),s.idLotePadre=s.noLotes.data[s.noLotes.data.length-1].idLotePago,s.estatusLote=s.noLotes.data[s.noLotes.data.length-1].estatus,s.ConsultaLote(s.noLotes.data[s.noLotes.data.length-1],s.noLotes.data.length,0),s.ProgPago=!0):(l.info("No existen Lotes"),s.NuevoLote=!0)},function t(a){l.error("Error al obtener los Lotes")})},a.LlenaIngresos=function(){c.getIngresos(a.idEmpresa,a.idLote).then(function e(o){s.ingresos=o.data,a.LlenaEgresos()},function o(a){l.error("Error al obtener los Ingresos")})},a.LlenaEgresos=function(){c.getEgresos(a.idEmpresa,a.idLote).then(function e(o){s.egresos=o.data,angular.forEach(s.TotalxEmpresas,function(a,e){angular.forEach(s.egresos,function(e,o){a.cuentaPagadora==e.cuenta&&(e.totalPagar=a.sumaSaldo)})}),angular.forEach(s.egresos,function(a,e){angular.forEach(s.ingresos,function(e,o){e.cuenta==a.cuenta&&(a.ingreso=1)})}),a.calculaTotalOperaciones(),L()},function o(a){l.error("Error al obtener los Egresos")})},a.MuestraGridModal=function(a){setTimeout(function(){s.selectAllModal(),s.showGrid=!0},5e3)},a.OcultaGridModal=function(a){$("#btnTodalaCartera").button("loading"),s.selectAllModal(),s.showGrid=a,$("#btnTodalaCartera").button("reset")},a.IniciaLote=function(){s.crearLote=!0,$("#btnCrealote").button("loading"),null==s.formData.nombreLoteNuevo?(l.warning("Debe proporcionar el nombre del nuevo lote."),$("#btnCrealote").button("reset")):(a.gridOptions=null,y(),s.NuevoLote=!0,c.getDatos(a.idEmpresa).success(h).error(g))},a.ProgramacionPagos=function(){a.ObtieneLotes(0),a.LlenaIngresos(),s.accionPagina=!0,setTimeout(function(){$("#btnSelectAll").click()},500),a.grdinicia=a.grdinicia+1},a.llenaGrid=function(){s.showGrid?c.getDatos(a.idEmpresa).success(b).error(g):(c.getDatos(a.idEmpresa).success(b).error(g),a.llenaEncabezado())};var h=function(e,o,t,n){a.data=e,a.carteraVencida=0,a.cantidadTotal=0,a.cantidadUpdate=0,a.noPagable=0,a.Reprogramable=0;for(var r=0;r<a.data.length;r++)a.data[r].Pagar=a.data[r].saldo,a.data[r].fechaPago=a.data[r].fechaPromesaPago,a.data[r].estGrid="Inicio","1900-01-01T00:00:00"==a.data[r].fechaPromesaPago&&(a.data[r].fechaPromesaPago=""),"True"==a.data[r].ordenBloqueada&&(a.data[r].Pagar=a.data[r].saldo),"False"==a.data[r].documentoPagable&&(a.data[r].Pagar=a.data[r].saldo),a.carteraVencida=a.carteraVencida+a.data[r].saldo;a.noPagable=a.carteraVencida-a.cantidadTotal,s.datosModal=a.data;var i={idLotePago:"0",idEmpresa:a.idEmpresa,idUsuario:s.currentEmployee,fecha:"",nombre:s.formData.nombreLoteNuevo,estatus:0};a.ObtieneLotes(i),a.LlenaIngresos(),s.estatusLote=0,s.accionPagina=!0},b=function(e,o,t,n){s.accionPagina&&(s.NuevoLote?s.NuevoLote=!1:(null==a.gridOptions&&y(),a.gridOptions.data=e)),a.data=e,a.carteraVencida=0,a.cantidadTotal=0,a.cantidadUpdate=0,a.noPagable=0,a.Reprogramable=0;for(var r=0;r<a.data.length;r++)a.data[r].Pagar=a.data[r].saldo,a.data[r].fechaPago=a.data[r].fechaPromesaPago,a.data[r].estGrid="Inicio","1900-01-01T00:00:00"==a.data[r].fechaPromesaPago&&(a.data[r].fechaPromesaPago=""),"True"==a.data[r].ordenBloqueada&&(a.data[r].Pagar=a.data[r].saldo),"False"==a.data[r].documentoPagable&&(a.data[r].Pagar=a.data[r].saldo),a.carteraVencida=a.carteraVencida+a.data[r].saldo;a.noPagable=a.carteraVencida-a.cantidadTotal,s.accionPagina?a.gridOptions.data=e:s.setDataGridModal(a.data),setTimeout(function(){},500)},E=function(e,o,t,n){null==a.gridOptions&&y(),a.gridOptions.data=null,a.gridOptions.data=e,a.data=e,a.carteraVencida=0,a.cantidadTotal=0,a.cantidadUpdate=0,a.noPagable=0,a.Reprogramable=0;for(var r=0;r<a.data.length;r++)a.data[r].Pagar=a.data[r].saldo,a.data[r].fechaPago=a.data[r].fechaPromesaPago,a.data[r].estGrid="Inicio","1900-01-01T00:00:00"==a.data[r].fechaPromesaPago&&(a.data[r].fechaPromesaPago=""),"True"==a.data[r].ordenBloqueada&&(a.data[r].Pagar=a.data[r].saldo),"False"==a.data[r].documentoPagable&&(a.data[r].Pagar=a.data[r].saldo),a.carteraVencida=a.carteraVencida+a.data[r].saldo;a.noPagable=a.carteraVencida-a.cantidadTotal,a.gridOptions.data=e,setTimeout(function(){$("#inicioModal").modal("hide")},500)},P=function(a,e){return a.forEach(function(a){a.grouping&&a.grouping.groupPriority>-1&&a.treeAggregation.type!==t.aggregation.CUSTOM&&(a.treeAggregation.type=t.aggregation.CUSTOM,a.customTreeAggregationFn=function(a,e,o,t){"undefined"==typeof a.value&&(a.value=0),a.value=a.value+t.entity.Pagar},a.customTreeAggregationFinalizerFn=function(a){"undefined"!=typeof a.groupVal?a.rendered=a.groupVal+" ("+r("currency")(a.value)+")":a.rendered=null})}),a},y=function(){a.idEmpleado=s.currentEmployee,a.gridOptions={enableColumnResize:!0,enableRowSelection:!0,enableGridMenu:!0,enableFiltering:!0,enableGroupHeaderSelection:!0,treeRowHeaderAlwaysVisible:!0,showColumnFooter:!0,showGridFooter:!0,height:900,cellEditableCondition:function(a){return a.row.entity.ordenBloqueada},columnDefs:[{name:"nombreAgrupador",grouping:{groupPriority:0},sort:{priority:0,direction:"asc"},width:"15%",displayName:"Grupo",enableCellEdit:!1},{name:"proveedor",grouping:{groupPriority:1},sort:{priority:1,direction:"asc"},width:"15%",name:"proveedor",width:"20%",cellTemplate:'<div><div ng-if="!col.grouping || col.grouping.groupPriority === undefined || col.grouping.groupPriority === null || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div></div>'},{field:"Pagar",displayName:"Pagar (total)",width:"10%",cellFilter:"currency",aggregationType:n.aggregationTypes.sum,treeAggregationType:t.aggregation.SUM,enableCellEdit:1==s.currentIdOp?!1:!0,editableCellTemplate:'<div><form name="inputForm"><input type="number" ng-class="\'colt\' + col.uid" ui-grid-editor ng-model="MODEL_COL_FIELD"></form></div>',customTreeAggregationFinalizerFn:function(a){a.rendered=a.value}},{field:"saldoPorcentaje",displayName:"Porcentaje %",width:"10%",cellFilter:"number: 6",aggregationType:n.aggregationTypes.sum,treeAggregationType:t.aggregation.SUM,enableCellEdit:!1,customTreeAggregationFinalizerFn:function(a){a.rendered=a.value}},{name:"fechaPromesaPago",displayName:"Fecha Promesa de Pago",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%"},{name:"documento",displayName:"# Documento",width:"15%",enableCellEdit:!1,headerTooltip:"Documento # de factura del provedor",cellClass:"cellToolTip"},{name:"ordenCompra",displayName:"Orden de compra",width:"13%",enableCellEdit:!1,cellTemplate:'<div class="urlTabla" ng-class="col.colIndex()" ><A class="urlTabla" HREF="http://192.168.20.9:3200/?id={{row.entity.ordenCompra}}&employee='+a.idEmpleado+'" TARGET="_new">{{row.entity.ordenCompra}}</A></div>'},{name:"monto",displayName:"Monto",width:"15%",cellFilter:"currency",enableCellEdit:!1},{name:"saldo",displayName:"Saldo",width:"15%",cellFilter:"currency",enableCellEdit:!1},{name:"tipo",width:"15%",displayName:"Tipo",enableCellEdit:!1},{name:"tipodocto",width:"15%",displayName:"Tipo Documento",enableCellEdit:!1},{name:"cartera",width:"15%",displayName:"Cartera",enableCellEdit:!1},{name:"moneda",width:"10%",displayName:"Moneda",enableCellEdit:!1},{name:"fechaVencimiento",displayName:"Fecha de Vencimiento",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%",enableCellEdit:!1},{name:"fechaRecepcion",displayName:"Fecha Recepción",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%",enableCellEdit:!1},{name:"fechaFactura",displayName:"Fecha Factura",type:"date",cellFilter:'date:"dd/MM/yyyy"',width:"17%",enableCellEdit:!1},{name:"estatus",displayName:"Estatus",width:"10%",enableCellEdit:!1},{name:"anticipo",displayName:"Anticipo",width:"10%",enableCellEdit:!1},{name:"anticipoAplicado",displayName:"Anticipo Aplicado",width:"15%",enableCellEdit:!1},{name:"cuenta",width:"15%",displayName:"# Cuenta"},{name:"documentoPagable",width:"15%",displayName:"Estatus del Documento",visible:!1},{name:"ordenBloqueada",displayName:"Bloqueada",width:"20%",visible:!1},{name:"cuentaPagadora",width:"15%",displayName:"Banco"},{name:"fechaPago",displayName:"fechaPago",width:"20%",visible:!1},{name:"estGrid",width:"15%",displayName:"Estatus Grid"}],rowTemplate:"<div ng-class=\"{'ordenBloqueada':(row.entity.ordenBloqueada=='True' && ((row.entity.idEstatus < 1 || row.entity.idEstatus > 5) && row.entity.idEstatus != 20) && !row.isSelected),'bloqueadaSelec': (row.isSelected && row.entity.ordenBloqueada=='True') || (row.isSelected && ((row.entity.idEstatus >= 1 && row.entity.idEstatus <= 5) || row.entity.idEstatus == 20)),'selectNormal': (row.isSelected && row.entity.ordenBloqueada=='False' && ((row.entity.idEstatus < 1 || row.entity.idEstatus > 5) && row.entity.idEstatus != 20)),'docIncompletos': (!row.isSelected && ((row.entity.idEstatus >= 1 && row.entity.idEstatus <= 5) || row.entity.idEstatus == 20) && row.entity.ordenBloqueada=='False'),'bloqDocIncom': (!row.isSelected && ((row.entity.idEstatus >= 1 && row.entity.idEstatus <= 5) || row.entity.idEstatus == 20) && row.entity.ordenBloqueada=='True')}\"> <div ng-repeat=\"(colRenderIndex, col) in colContainer.renderedColumns track by col.uid\" class=\"ui-grid-cell\" ng-class=\"{ 'ui-grid-row-header-cell': col.isRowHeader == 'True'}\" ui-grid-cell></div></div>",onRegisterApi:function(e){a.gridApi1=e,a.cantidadTotal=a.cantidadTotal,e.selection.on.rowSelectionChanged(a,function(o){if(1==o.internalRow&&1==o.isSelected)for(var t=o.treeNode.children,n=0,r=t.length;r>n;n++)a.selectAllChildren(e,t[n]);if(1==o.internalRow&&0==o.isSelected)for(var t=o.treeNode.children,n=0,r=t.length;r>n;n++)a.unSelectAllChildren(e,t[n]);o.isSelected?(s.grdNoIncluido=Math.round(100*s.grdNoIncluido)/100-Math.round(100*o.entity.Pagar)/100,a.grdinicia>0&&(i=0,s.grdBancos.forEach(function(a,e){o.entity.cuentaPagadora==s.grdBancos[i].banco&&(s.grdBancos[i].subtotal=Math.round(100*s.grdBancos[i].subtotal)/100+Math.round(100*o.entity.Pagar)/100,s.grdApagar=s.grdApagar+o.entity.Pagar,o.entity.estGrid="Inicio"),i++}))):(s.grdNoIncluido=Math.round(100*s.grdNoIncluido)/100+Math.round(100*o.entity.Pagar)/100,i=0,a.grdinicia>0&&s.grdBancos.forEach(function(a,e){o.entity.cuentaPagadora==s.grdBancos[i].banco&&(s.grdBancos[i].subtotal=Math.round(100*s.grdBancos[i].subtotal)/100-Math.round(100*o.entity.Pagar)/100,s.grdApagar=s.grdApagar-o.entity.Pagar,o.entity.estGrid="No Incluido"),i++}))}),e.selection.on.rowSelectionChangedBatch(a,function(e){e.forEach(function(e,o){e.isSelected?(s.grdNoIncluido=Math.round(100*s.grdNoIncluido)/100-Math.round(100*e.entity.Pagar)/100,a.grdinicia>0&&(o=0,s.grdBancos.forEach(function(a,t){e.entity.cuentaPagadora==s.grdBancos[o].banco&&"False"==e.entity.ordenBloqueada&&(s.grdBancos[o].subtotal=Math.round(100*s.grdBancos[o].subtotal)/100+Math.round(100*e.entity.Pagar)/100,s.grdApagar=s.grdApagar+e.entity.Pagar,e.entity.estGrid="Inicio"),o++}))):(s.grdNoIncluido=Math.round(100*s.grdNoIncluido)/100+Math.round(100*e.entity.Pagar)/100,o=0,a.grdinicia>0&&s.grdBancos.forEach(function(a,t){e.entity.cuentaPagadora==s.grdBancos[o].banco&&"False"==e.entity.ordenBloqueada&&(s.grdBancos[o].subtotal=Math.round(100*s.grdBancos[o].subtotal)/100-Math.round(100*e.entity.Pagar)/100,s.grdApagar=s.grdApagar-e.entity.Pagar,e.entity.estGrid="No Incluido"),o++}))})}),e.edit.on.afterCellEdit(a,function(e,o,t,n){if(old_date=new Date(e.fechaPago),n=e.saldo,"fechaPromesaPago"==o.name){dtHoy=Date.now(),now_date=new Date(dtHoy),new_date=new Date(t);var r=new Date,i=r.getDate(),d=r.getMonth()+1,c=r.getFullYear();new_date<now_date&&(l.warning("La fecha promesa de pago no puede ser menor a "+i+"/"+d+"/"+c+" !!!"),e.fechaPromesaPago=old_date),new_date>now_date&&(s.grdReprogramado=Math.round(100*s.grdReprogramado)/100+Math.round(100*e.Pagar)/100,s.grdApagar=Math.round(100*s.grdApagar)/100-Math.round(100*e.Pagar)/100,e.estGrid="Reprogramado")}"Pagar"==o.name&&(a.cantidadUpdate=t-n,t>n?(l.warning("El pago no puede ser mayor a "+n+"  !!!"),e.Pagar=n):(s.grdNoIncluido=Math.round(100*s.grdNoIncluido)/100-Math.round(100*a.cantidadUpdate)/100,s.grdApagar=Math.round(100*s.grdApagar)/100+Math.round(100*a.cantidadUpdate)/100,e.estGrid="No Incluido",e.fechaPromesaPago=old_date))})}}};a.selectAllChildren=function(e,o){if(0==o.children.length)e.selection.selectRow(o.row.entity);else{e.selection.selectRow(o.row.entity);for(var t=o.children,n=0,r=t.length;r>n;n++)a.selectAllChildren(e,t[n])}},a.unSelectAllChildren=function(e,o){if(0==o.children.length)e.selection.unSelectRow(o.row.entity);else{e.selection.unSelectRow(o.row.entity);for(var t=o.children,n=0,r=t.length;r>n;n++)a.unSelectAllChildren(e,t[n])}},a.seleccionaTodo=function(){a.selectAll(0)},a.selecciona=function(){a.selectAll(1)},a.selectAll=function(e){s.grdApagar=0,s.grdnoPagable=0,s.grdBancos=[],a.grdinicia=0,a.gridOptions.data.forEach(function(o,t){if("True"==o.ordenBloqueada?(s.grdnoPagable=Math.round(100*s.grdnoPagable)/100+Math.round(100*o.saldo)/100,s.grdApagar=Math.round(100*s.grdApagar)/100+Math.round(100*o.saldo)/100):(s.grdApagar=Math.round(100*s.grdApagar)/100+Math.round(100*o.saldo)/100,0==e&&a.gridApi1.selection.selectRow(a.gridOptions.data[t])),0==t)"SCP"!=o.cuentaPagadora&&s.grdBancos.push({banco:o.cuentaPagadora,subtotal:o.saldo});else{for(var n=!0,r=0,r=0;r<s.grdBancos.length;r++)s.grdBancos[r].banco==o.cuentaPagadora&&(n=!1,s.grdBancos[r].subtotal=s.grdBancos[r].subtotal+o.saldo);n&&"Sin CuentaPagadora"!=o.cuentaPagadora&&s.grdBancos.push({banco:o.cuentaPagadora,subtotal:o.saldo})}}),s.grdReprogramado=0,s.grdNoIncluido=0,a.gridOptions.isRowSelectable=function(a){return"True"==a.entity.ordenBloqueada?!1:!0},a.gridApi1.core.notifyDataChange(n.dataChange.OPTIONS),a.gridApi1.core.notifyDataChange(n.dataChange.EDIT),a.grdinicia=a.grdinicia+1},a.Filtrar=function(e,o){a.BorraFiltros(),a.gridApi1.grid.columns[o].filters[0].term=e,a.gridApi1.core.notifyDataChange(n.dataChange.COLUMN),a.gridApi1.grid.refresh()},a.BorraFiltros=function(){a.gridApi1.grid.columns.forEach(function(e,o){a.gridApi1.grid.columns[o].filters[0].term=""}),a.gridApi1.core.notifyDataChange(n.dataChange.COLUMN),a.gridApi1.grid.refresh()};var w=function(a){return!Array.isArray(a)&&a-parseFloat(a)+1>=0};a.colapsado=!1,a.Resize=function(){a.colapsado=!a.colapsado},s.ConsultaLote=function(a,e,o){1==o?confirm("¿Al cambiar de lote se perderan los cambios no guardados. Desea continuar??")&&s.ConsultaLoteObtiene(a,e):s.ConsultaLoteObtiene(a,e)},s.ConsultaLoteObtiene=function(e,o){l.info("Consulta de Lote "+o),a.idLote=e.idLotePago,s.idLotePadre=e.idLotePago,s.nombreLote=e.nombre,s.estatusLote=e.estatus,s.accionPagina&&(a.LlenaIngresos(),c.getOtrosIngresos(a.idLote).then(function t(e){a.caja=0,a.cobrar=0,e.data.length>0&&(a.caja=e.data[0].pio_caja,a.cobrar=e.data[0].pio_cobranzaEsperada)},function n(a){l.error("Error al obtener Otros Ingresos.")}),c.getTransferencias(a.idLote).then(function r(e){if(a.transferencias=[],e.data.length>0)angular.forEach(e.data,function(e,o){var t=e;a.transferencias.push(t)});else{var t={bancoOrigen:"",bancoDestino:"",importe:0,index:o};a.transferencias.push(t)}},function i(a){l.error("Error al obtener Transferencias.")}),0==s.estatusLote?(a.gridOptions.data=s.datosModal,$("#btnTotalxEmpresa").button("reset"),s.crearLote&&($("#inicioModal").modal("hide"),s.crearLote=!1)):c.getDatosAprob(a.idLote).success(E).error(g),setTimeout(function(){$("#btnSelectAll").click()},500)),a.grdinicia=a.grdinicia+1},a.Guardar=function(){$("#btnGuardando").button("loading");var a=0,e=0;angular.forEach(s.ingresos,function(o,t){parseInt(o.disponible)<0&&(a+=1),e=parseInt(e)+parseInt(o.saldo)}),setTimeout(function(){T(a,e)},500)},a.Cancelar=function(){a.gridOptions.data=[],s.noLotes=null,a.ObtieneLotes(0),setTimeout(function(){0==s.noLotes.data.length&&(s.NuevoLote=!0,s.estatusLote=0,s.CrearNuevoLote())},500)};var T=function(e,o){if(e>0)l.warning("Existen disponibles en valores negativos. Verifique las transferencias."),$("#btnGuardando").button("reset");else if(0>=o)l.warning("La sumatoria del saldo de cuentas de Ingreso no puede ser cero."),$("#btnGuardando").button("reset");else{var t=a.gridApi1.selection.getSelectedRows();0==t.length?(l.warning("Debe seleccionar al menos un documento para guardar un lote."),$("#btnGuardando").button("reset")):c.getPagosPadre(a.idEmpresa,s.currentEmployee,s.formData.nombreLoteNuevo,s.idLotePadre).then(function n(e){s.idLotePadre=e.data;var o=[],n=0;t.forEach(function(a,e){var t={};t.pal_id_lote_pago=s.idLotePadre,t.pad_polTipo=a.polTipo,t.pad_polAnnio=a.annio,t.pad_polMes=a.polMes,t.pad_polConsecutivo=a.polConsecutivo,t.pad_polMovimiento=a.polMovimiento,t.pad_fechaPromesaPago=""==a.fechaPromesaPago?"01/01/1999":a.fechaPromesaPago,t.pad_saldo=a.saldo,t.tab_revision=1,o.push(t)});var r=angular.toJson(s.ingresos),i=angular.toJson(a.transferencias),d=angular.toJson(s.egresos);c.setDatos(o,s.currentEmployee,s.idLotePadre,r,i,a.caja,a.cobrar,d,0==s.estatusLote?1:2).then(function u(e){l.success("Se guardaron los datos."),s.estatusLote=1,angular.forEach(s.noLotes.data,function(e,o){e.idLotePago==a.idLote&&(e.idLotePago=s.idLotePadre,e.estatus=1)}),$("#btnGuardando").button("reset")},function g(a){l.error("Error al guardar Datos"),$("#btnGuardando").button("reset")}),$("#btnguardando").button("reset")},function r(a){l.error("Error al insertar en tabla padre."),$("#btnguardando").button("reset")})}};a.addTransferencia=function(){var e=a.transferencias.length,o={bancoOrigen:"",bancoDestino:"",importe:0,index:e};a.transferencias.push(o)},a.delTransferencia=function(e){a.transferencias.splice(e.index,1);var o=0;angular.forEach(a.transferencias,function(a,e){a.index=o,o+=1}),a.calculaTotalOperaciones(),L()},a.selBancoIngreso=function(e,o){e.disponible<=0?l.warning("El saldo disponible de esta cuenta es 0 o menor. Elija otra."):o.bancoOrigen!=e.cuenta&&(angular.forEach(s.ingresos,function(a,e){a.cuenta==o.bancoOrigen&&(a.disponible=parseInt(a.disponible)+parseInt(o.importe))}),o.bancoOrigen=e.cuenta,o.disponibleOrigen=e.disponible,o.importe=0),a.calculaTotalOperaciones(),L()},a.selBancoEgreso=function(e,o){o.bancoDestino=e.cuenta,a.calculaTotalOperaciones(),L()},a.calculaSaldoIngresos=function(e){var o=0;angular.forEach(a.transferencias,function(a,t){a.bancoOrigen==e.cuenta&&(o=parseInt(o)+parseInt(a.importe))}),e.disponible=parseInt(e.saldo)-parseInt(o),angular.forEach(s.egresos,function(a,o){e.cuenta==a.cuenta&&1==a.ingreso&&(a.saldoIngreso=e.disponible)}),angular.forEach(a.transferencias,function(a,o){a.bancoOrigen==e.cuenta&&(a.disponibleOrigen=e.disponible)}),parseInt(e.disponible)<0&&l.warning("El saldo disponible de esta cuenta es menor a 0. Verifique las transferencias."),a.calculaTotalOperaciones()},a.calculaTransferencia=function(e){var o=0;angular.forEach(a.transferencias,function(a,t){a.bancoOrigen==e.bancoOrigen&&(o+=1)}),1==o?(e.importe>e.disponibleOrigen||e.disponibleOrigen<=0)&&(l.warning("El valor es mayor al saldo disponible!"),e.importe=0):angular.forEach(s.ingresos,function(a,o){a.cuenta==e.bancoOrigen&&(a.disponible-e.importe<0?(l.warning("El valor es mayor al saldo disponible!"),e.importe=0):a.disponible=a.disponible-e.importe)}),a.calculaTotalOperaciones(),L()};var L=function(){angular.forEach(s.ingresos,function(e,o){e.disponible=e.saldo,angular.forEach(a.transferencias,function(a,o){e.cuenta==a.bancoOrigen&&(e.disponible=e.disponible-a.importe)}),angular.forEach(s.TotalxEmpresas,function(a,e){angular.forEach(s.egresos,function(e,o){a.cuentaPagadora==e.cuenta&&(a.saldoLote=e.total)})})})};a.calculaTotalOperaciones=function(){angular.forEach(s.egresos,function(e,o){var t=0;angular.forEach(a.transferencias,function(a,o){a.bancoDestino==e.cuenta&&(t+=parseInt(a.importe))}),angular.forEach(s.ingresos,function(a,o){a.cuenta==e.cuenta&&1==e.ingreso&&(e.saldoIngreso=a.saldo)}),e.aTransferir=t;var n=parseInt(e.ingreso),r=1==n?parseInt(e.saldoIngreso):parseInt(e.saldo);e.total=parseInt(e.aTransferir)+r,e.excedente=parseInt(e.totalPagar)-parseInt(e.total)})},a.presskey=function(e){13===e.which&&(a.calculaTotalOperaciones(),L())},a.getTotal=function(e){var o=0;switch(e){case"egresosTotal":angular.forEach(s.egresos,function(a,e){o+=parseInt(a.total)}),s.FlujoEfectivo=o;break;case"ingresoSaldo":angular.forEach(s.ingresos,function(a,e){o+=parseInt(""==a.saldo?0:a.saldo)});break;case"ingresoDisponible":angular.forEach(s.ingresos,function(a,e){o+=parseInt(""==a.disponible?0:a.disponible)});break;case"excedente":angular.forEach(s.egresos,function(a,e){o+=parseInt(a.excedente)});break;case"otrosIngresos":o+=parseInt(""==a.caja||null==a.caja?0:a.caja)+parseInt(""==a.cobrar||null==a.cobrar?0:a.cobrar);break;case"transferencias":angular.forEach(a.transferencias,function(a,e){o+=parseInt(a.importe)});break;case"saldo":angular.forEach(s.egresos,function(a,e){o+=1==a.ingreso?parseInt(a.saldoIngreso):parseInt(a.saldo)});break;case"aTransferir":angular.forEach(s.egresos,function(a,e){o+=parseInt(a.aTransferir)})}return o},s.CrearNuevoLote=function(){$("#closeMenu").click(),s.ProgPago=!0;var a=$.grep(s.noLotes.data,function(a,e){return 0===a.estatus});a.length>0?l.warning("Existe lotes sin guardar."):(s.NuevoLote=!0,$("#inicioModal").modal("show"),s.accionPagina=!1,$("#btnCrealote").button("reset"),null==s.formData.nombreLoteNuevo)},$('input[name="options"]').click(function(){$(this).tab("show")}),a.GenerarArchivo=function(){$("#processing-modal").modal("show"),c.setArchivo(a.idEmpresa,a.gridOptions.data,s.idLotePadre).then(function e(o){a.documentoIni='<div><object id="ifDocument" data="'+o.data+'" type="application/txt" width="100%"><p>Descargar archivo de pagos <a href="../../files/'+o.data+'" target="_blank"><img border="0" alt="descargar" src="image/gifs/download.jpg" width="50" height="50"></a></p></object> </div>',setTimeout(function(){$("#processing-modal").modal("hide")},1e3),$("#divDocumento").append(a.documentoIni)},function o(a){l.error("Error al generar el archivo"),setTimeout(function(){$("#processing-modal").modal("hide")},1e3)})},s.EnviaAprobacion=function(){$("#btnEnviaApro").button("loading"),c.setSolAprobacion(1,8,a.idEmpresa,s.idLotePadre).then(function e(a){l.success("Se envio la solicitud con exito"),$("#btnEnviaApro").button("reset")},function o(a){l.error("Error al enviar solicitud de aprobación"),$("#btnEnviaApro").button("reset")})},s.AprobarLote=function(e){$("#btnAprobar").button("loading"),c.setAprobacion(1,e,a.idEmpresa,s.idLotePadre,s.currentEmployee).then(function o(a){3==e?(l.success("Se aprobo el lote con exito"),$("#btnAprobar").button("reset")):(l.success("Se rechazo el lote con exito"),$("#btnRechazar").button("reset")),$("#btnAprobar").prop("disabled",!0),$("#btnRechazar").prop("disabled",!0)},function t(a){l.error("Error al aprobar"),$("#btnAprobar").button("reset")})}}),registrationModule.service("stats",function(){var a=function(a,o){e(a),angular.isUndefined(a.stats.accumulator)&&(a.stats.accumulator=[]),a.stats.accumulator.push(o)},e=function(a){angular.isUndefined(a.stats)&&(a.stats={sum:0})},o=function(a,e){angular.isUndefined(a[e])?a[e]=1:a[e]++},t={aggregator:{accumulate:{numValue:function(e,o,t){return a(e,t)},fieldValue:function(e,o){return a(e,o)}},mode:function(a,t){e(a);var n=t;(angular.isUndefined(n)||null===n)&&(n=a.col.grid.options.groupingNullLabel),o(a.stats,n),(a.stats[n]>a.maxCount||angular.isUndefined(a.maxCount))&&(a.maxCount=a.stats[n],a.value=n)},sumSquareErr:function(a,n,r){e(a),o(a.stats,"count"),a.stats.sum+=r,t.aggregator.accumulate.numValue(a,n,r)}},finalizer:{cleanup:function(a){delete a.stats,angular.isUndefined(a.rendered)&&(a.rendered=a.value)},sumSquareErr:function(a){if(a.value=0,0!==a.count){var e=a.stats.sum/a.stats.count,o;angular.forEach(a.stats.accumulator,function(t){o=t-e,a.value+=o*o})}}}};return t});